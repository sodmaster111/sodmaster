<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Sodmaster</title>
  <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
  <div class="admin-container">
    <div class="header">
      <h1>ðŸ¤– Sodmaster Admin Dashboard</h1>
      <p>Real-time subscription monitoring</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Subscriptions</h3>
        <div class="value" id="total-subs">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Revenue (USD)</h3>
        <div class="value" id="total-revenue">$0</div>
      </div>
      <div class="stat-card">
        <h3>Starter Plans</h3>
        <div class="value" id="starter-count">0</div>
      </div>
      <div class="stat-card">
        <h3>Pro Plans</h3>
        <div class="value" id="pro-count">0</div>
      </div>
      <div class="stat-card">
        <h3>Alpha Plans</h3>
        <div class="value" id="alpha-count">0</div>
      </div>
    </div>

    <div class="subscribers-table">
      <div class="table-header">
        <h2>Recent Subscriptions</h2>
        <button class="export-btn" onclick="exportToCSV()">ðŸ“¥ Export CSV</button>
      </div>

      <table id="subscribers-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Plan</th>
            <th>Amount</th>
            <th>Crypto</th>
            <th>Transaction Hash</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              Loading subscriptions...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let subscriptions = [];

    async function loadSubscriptions() {
      try {
        const response = await fetch('/api/v1/subscriptions');
        subscriptions = await response.json();
        
        updateStats();
        renderTable();
      } catch (error) {
        console.error('Error loading subscriptions:', error);
      }
    }

    function updateStats() {
      const total = subscriptions.length;
      const revenue = subscriptions.reduce((sum, sub) => sum + sub.amount_usd, 0);
      const starter = subscriptions.filter(s => s.plan === 'starter').length;
      const pro = subscriptions.filter(s => s.plan === 'pro').length;
      const alpha = subscriptions.filter(s => s.plan === 'alpha').length;

      document.getElementById('total-subs').textContent = total;
      document.getElementById('total-revenue').textContent = '$' + revenue.toLocaleString();
      document.getElementById('starter-count').textContent = starter;
      document.getElementById('pro-count').textContent = pro;
      document.getElementById('alpha-count').textContent = alpha;
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      
      if (subscriptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No subscriptions yet</td></tr>';
        return;
      }

      tbody.innerHTML = subscriptions.map(sub => `
        <tr>
          <td>${sub.email}</td>
          <td><span class="plan-badge plan-${sub.plan}">${sub.plan.toUpperCase()}</span></td>
          <td>$${sub.amount_usd}</td>
          <td><span class="crypto-badge">${sub.crypto.toUpperCase()}</span></td>
          <td><span class="tx-hash" title="${sub.tx_hash}">${sub.tx_hash}</span></td>
          <td>${sub.status}</td>
          <td>${new Date(sub.created_at).toLocaleDateString()}</td>
        </tr>
      `).join('');
    }

    function exportToCSV() {
      if (subscriptions.length === 0) {
        alert('No subscriptions to export');
        return;
      }

      const headers = ['Email', 'Plan', 'Amount USD', 'Crypto', 'Transaction Hash', 'Status', 'Date'];
      const rows = subscriptions.map(sub => [
        sub.email,
        sub.plan,
        sub.amount_usd,
        sub.crypto,
        sub.tx_hash,
        sub.status,
        new Date(sub.created_at).toISOString()
      ]);

      let csv = headers.join(',') + '\n';
      csv += rows.map(row => row.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sodmaster-subscriptions-' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
    }

    // Auto-refresh every 10 seconds
    loadSubscriptions();
    setInterval(loadSubscriptions, 10000);
  </script>
</body>
</html>

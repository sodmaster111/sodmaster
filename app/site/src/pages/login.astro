---
import BaseLayout from '../layouts/BaseLayout.astro';

const telegramBot = import.meta.env.TELEGRAM_BOT_NAME ?? '';
---

<BaseLayout title="Login" description="Authenticate with Google or Telegram.">
  <section class="login">
    <h1>Sign in</h1>
    <p>Choose a provider to continue to the Sodmaster console.</p>
    <div class="actions">
      <a class="login-button google" href="/auth/google/login">Continue with Google</a>
      {telegramBot ? (
        <button class="login-button telegram" id="telegramLogin">Continue with Telegram</button>
      ) : (
        <button class="login-button telegram" type="button" disabled>Continue with Telegram</button>
      )}
    </div>
    <div id="telegramWidget" class="telegram-widget" aria-hidden="true"></div>
  </section>

  <script>
    const botName = {JSON.stringify(telegramBot)};
    if (botName) {
      const container = document.getElementById('telegramWidget');
      const button = document.getElementById('telegramLogin');
      const injectWidget = () => {
        if (!container || container.childElementCount > 0) return;
        const script = document.createElement('script');
        script.src = 'https://telegram.org/js/telegram-widget.js?19';
        script.async = true;
        script.setAttribute('data-telegram-login', botName);
        script.setAttribute('data-size', 'large');
        script.setAttribute('data-radius', '4');
        script.setAttribute('data-userpic', 'false');
        script.setAttribute('data-onauth', 'window.handleTelegramAuth(user)');
        container.appendChild(script);
        container.removeAttribute('aria-hidden');
      };
      window.handleTelegramAuth = async (user) => {
        try {
          const response = await fetch('/auth/telegram/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
          });
          if (response.ok) {
            window.location.href = '/admin';
          } else {
            console.error('Telegram verification failed');
          }
        } catch (err) {
          console.error('Telegram verification failed', err);
        }
      };
      if (button) {
        button.addEventListener('click', injectWidget, { once: true });
      } else {
        injectWidget();
      }
    }
  </script>
</BaseLayout>

<style>
  .login {
    max-width: 480px;
    margin: 3rem auto;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.04);
    border-radius: 12px;
    text-align: center;
  }

  .login h1 {
    margin-bottom: 0.5rem;
    font-size: 2rem;
  }

  .login p {
    color: rgba(255, 255, 255, 0.75);
  }

  .actions {
    display: grid;
    gap: 1rem;
    margin: 2rem 0;
  }

  .login-button {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    padding: 0.85rem 1.5rem;
    border-radius: 999px;
    border: 1px solid transparent;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .login-button.google {
    background: #fff;
    color: #1a1a1a;
  }

  .login-button.telegram {
    background: #2aabee;
    color: #fff;
  }

  .login-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  .login-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  }

  .telegram-widget {
    display: flex;
    justify-content: center;
  }
</style>
